{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "9054443423865730822"
    }
  },
  "parameters": {
    "environment": {
      "type": "string"
    },
    "location": {
      "type": "string",
      "defaultValue": "westus3"
    },
    "storageLocation": {
      "type": "string",
      "defaultValue": "eastus"
    },
    "namePrefix": {
      "type": "string",
      "defaultValue": "agent13"
    },
    "entraClientId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Entra ID app registration client ID for authentication. Leave empty to disable auth."
      }
    },
    "allowedClientApplications": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Allowed client application IDs for app-to-app API access. Leave empty to allow any app that has the required API role."
      }
    },
    "searchIndexName": {
      "type": "string",
      "defaultValue": "legal-index",
      "metadata": {
        "description": "Azure AI Search index name used by the API."
      }
    },
    "botEntraAppId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Entra ID app registration client ID for the Bot Service. Leave empty to skip bot deployment."
      }
    },
    "budgetContactEmails": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Email addresses for budget alert notifications."
      }
    },
    "enableNetworking": {
      "type": "bool",
      "defaultValue": "[equals(parameters('environment'), 'prod')]",
      "metadata": {
        "description": "Enable VNet integration and private endpoints for production security."
      }
    }
  },
  "resources": [
    {
      "condition": "[parameters('enableNetworking')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "networking",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-{1}', parameters('namePrefix'), parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "7663440609690905511"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-05-01",
              "name": "[format('vnet-{0}', parameters('name'))]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "10.0.0.0/16"
                  ]
                },
                "subnets": [
                  {
                    "name": "snet-app",
                    "properties": {
                      "addressPrefix": "10.0.1.0/24",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-app-{0}', parameters('name')))]"
                      },
                      "delegations": [
                        {
                          "name": "delegation-app",
                          "properties": {
                            "serviceName": "Microsoft.Web/serverFarms"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "name": "snet-private-endpoints",
                    "properties": {
                      "addressPrefix": "10.0.2.0/24",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-pe-{0}', parameters('name')))]"
                      }
                    }
                  },
                  {
                    "name": "snet-bot",
                    "properties": {
                      "addressPrefix": "10.0.3.0/24",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-bot-{0}', parameters('name')))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-app-{0}', parameters('name')))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-bot-{0}', parameters('name')))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-pe-{0}', parameters('name')))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('nsg-app-{0}', parameters('name'))]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowHTTPS",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('nsg-pe-{0}', parameters('name'))]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('nsg-bot-{0}', parameters('name'))]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowHTTPS",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "AzureBotService",
                      "destinationAddressPrefix": "*"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "privatelink.search.windows.net",
              "location": "global"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "privatelink.openai.azure.com",
              "location": "global"
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "privatelink.vaultcore.azure.net",
              "location": "global"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', 'privatelink.search.windows.net', 'link-search')]",
              "location": "global",
              "properties": {
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', parameters('name')))]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.search.windows.net')]",
                "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', parameters('name')))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', 'privatelink.openai.azure.com', 'link-openai')]",
              "location": "global",
              "properties": {
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', parameters('name')))]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.openai.azure.com')]",
                "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', parameters('name')))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', 'privatelink.vaultcore.azure.net', 'link-kv')]",
              "location": "global",
              "properties": {
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', parameters('name')))]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]",
                "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', parameters('name')))]"
              ]
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', format('vnet-{0}', parameters('name')))]"
            },
            "appSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', format('vnet-{0}', parameters('name')), 'snet-app')]"
            },
            "peSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', format('vnet-{0}', parameters('name')), 'snet-private-endpoints')]"
            },
            "botSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', format('vnet-{0}', parameters('name')), 'snet-bot')]"
            },
            "searchDnsZoneId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.search.windows.net')]"
            },
            "openaiDnsZoneId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.openai.azure.com')]"
            },
            "kvDnsZoneId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('st{0}', uniqueString(resourceGroup().id))]"
          },
          "location": {
            "value": "[parameters('storageLocation')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "12398565317711343304"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2"
            }
          ],
          "outputs": {
            "storageName": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "search",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-search-{1}', parameters('namePrefix'), parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "enablePrivateEndpoint": {
            "value": "[parameters('enableNetworking')]"
          },
          "privateEndpointSubnetId": "[if(parameters('enableNetworking'), createObject('value', coalesce(tryGet(tryGet(tryGet(if(parameters('enableNetworking'), reference(resourceId('Microsoft.Resources/deployments', 'networking'), '2025-04-01'), null()), 'outputs'), 'peSubnetId'), 'value'), '')), createObject('value', ''))]",
          "privateDnsZoneId": "[if(parameters('enableNetworking'), createObject('value', coalesce(tryGet(tryGet(tryGet(if(parameters('enableNetworking'), reference(resourceId('Microsoft.Resources/deployments', 'networking'), '2025-04-01'), null()), 'outputs'), 'searchDnsZoneId'), 'value'), '')), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "4354851456932075821"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "enablePrivateEndpoint": {
              "type": "bool",
              "defaultValue": false
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateDnsZoneId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "resources": [
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2023-11-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "basic"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "replicaCount": 1,
                "partitionCount": 1,
                "hostingMode": "default",
                "publicNetworkAccess": "[if(parameters('enablePrivateEndpoint'), 'disabled', 'enabled')]",
                "semanticSearch": "free"
              }
            },
            {
              "condition": "[parameters('enablePrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[format('pe-{0}', parameters('name'))]",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('plsc-{0}', parameters('name'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Search/searchServices', parameters('name'))]",
                      "groupIds": [
                        "searchService"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Search/searchServices', parameters('name'))]"
              ]
            },
            {
              "condition": "[parameters('enablePrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', format('pe-{0}', parameters('name')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}', parameters('name')))]"
              ]
            }
          ],
          "outputs": {
            "searchName": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "searchEndpoint": {
              "type": "string",
              "value": "[format('https://{0}.search.windows.net', parameters('name'))]"
            },
            "searchId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Search/searchServices', parameters('name'))]"
            },
            "searchPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Search/searchServices', parameters('name')), '2023-11-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'networking')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "openai",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-openai-{1}', parameters('namePrefix'), parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "enablePrivateEndpoint": {
            "value": "[parameters('enableNetworking')]"
          },
          "privateEndpointSubnetId": "[if(parameters('enableNetworking'), createObject('value', coalesce(tryGet(tryGet(tryGet(if(parameters('enableNetworking'), reference(resourceId('Microsoft.Resources/deployments', 'networking'), '2025-04-01'), null()), 'outputs'), 'peSubnetId'), 'value'), '')), createObject('value', ''))]",
          "privateDnsZoneId": "[if(parameters('enableNetworking'), createObject('value', coalesce(tryGet(tryGet(tryGet(if(parameters('enableNetworking'), reference(resourceId('Microsoft.Resources/deployments', 'networking'), '2025-04-01'), null()), 'outputs'), 'openaiDnsZoneId'), 'value'), '')), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "5589261746827644732"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "enablePrivateEndpoint": {
              "type": "bool",
              "defaultValue": false
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateDnsZoneId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "kind": "OpenAI",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "customSubDomainName": "[parameters('name')]",
                "publicNetworkAccess": "[if(parameters('enablePrivateEndpoint'), 'disabled', 'enabled')]"
              }
            },
            {
              "condition": "[parameters('enablePrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[format('pe-{0}', parameters('name'))]",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('plsc-{0}', parameters('name'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]",
                      "groupIds": [
                        "account"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "condition": "[parameters('enablePrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', format('pe-{0}', parameters('name')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}', parameters('name')))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('name'), 'gpt-4o')]",
              "sku": {
                "name": "Standard",
                "capacity": 1
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "gpt-4o",
                  "version": "2024-05-13"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('name'), 'text-embedding-3-large')]",
              "sku": {
                "name": "Standard",
                "capacity": 1
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "text-embedding-3-large",
                  "version": "1"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/deployments', parameters('name'), 'gpt-4o')]",
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2023-05-01').endpoint]"
            },
            "chatDeploymentName": {
              "type": "string",
              "value": "gpt-4o"
            },
            "embeddingDeploymentName": {
              "type": "string",
              "value": "text-embedding-3-large"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'networking')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyvault",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-kv-{1}', parameters('namePrefix'), parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "10888463687730723462"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "accessPolicies": [],
                "enableRbacAuthorization": true
              }
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('name')), '2023-07-01').vaultUri]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "monitoring",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-insights-{1}', parameters('namePrefix'), parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "16852350658217294804"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('law-{0}', parameters('name'))]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('law-{0}', parameters('name')))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('law-{0}', parameters('name')))]"
              ]
            }
          ],
          "outputs": {
            "instrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').InstrumentationKey]"
            },
            "appInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', parameters('name'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "app",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-app-{1}', parameters('namePrefix'), parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "appInsightsKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'monitoring'), '2025-04-01').outputs.instrumentationKey.value]"
          },
          "entraClientId": {
            "value": "[parameters('entraClientId')]"
          },
          "allowedClientApplications": {
            "value": "[parameters('allowedClientApplications')]"
          },
          "enableAuth": {
            "value": "[not(equals(parameters('entraClientId'), ''))]"
          },
          "vnetSubnetId": "[if(parameters('enableNetworking'), createObject('value', coalesce(tryGet(tryGet(tryGet(if(parameters('enableNetworking'), reference(resourceId('Microsoft.Resources/deployments', 'networking'), '2025-04-01'), null()), 'outputs'), 'appSubnetId'), 'value'), '')), createObject('value', ''))]",
          "enableVnetIntegration": {
            "value": "[parameters('enableNetworking')]"
          },
          "searchEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'search'), '2025-04-01').outputs.searchEndpoint.value]"
          },
          "searchIndex": {
            "value": "[parameters('searchIndexName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "6686897034821125728"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "appInsightsKey": {
              "type": "string"
            },
            "entraClientId": {
              "type": "string",
              "defaultValue": ""
            },
            "enableAuth": {
              "type": "bool",
              "defaultValue": false
            },
            "allowedClientApplications": {
              "type": "array",
              "defaultValue": []
            },
            "vnetSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "enableVnetIntegration": {
              "type": "bool",
              "defaultValue": false
            },
            "searchEndpoint": {
              "type": "string",
              "defaultValue": ""
            },
            "searchIndex": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[format('plan-{0}', parameters('name'))]",
              "location": "[parameters('location')]",
              "kind": "linux",
              "sku": {
                "name": "B1",
                "tier": "Basic"
              },
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "kind": "app,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('plan-{0}', parameters('name')))]",
                "virtualNetworkSubnetId": "[if(parameters('enableVnetIntegration'), parameters('vnetSubnetId'), null())]",
                "httpsOnly": true,
                "siteConfig": {
                  "linuxFxVersion": "DOTNETCORE|8.0",
                  "alwaysOn": true,
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "http20Enabled": true,
                  "appSettings": [
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[parameters('appInsightsKey')]"
                    },
                    {
                      "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                      "value": "~3"
                    },
                    {
                      "name": "AzureSearch__Endpoint",
                      "value": "[parameters('searchEndpoint')]"
                    },
                    {
                      "name": "AzureSearch__Index",
                      "value": "[parameters('searchIndex')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', format('plan-{0}', parameters('name')))]"
              ]
            },
            {
              "condition": "[parameters('enableAuth')]",
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('name'), 'authsettingsV2')]",
              "properties": {
                "globalValidation": {
                  "requireAuthentication": true,
                  "unauthenticatedClientAction": "Return401"
                },
                "identityProviders": {
                  "azureActiveDirectory": {
                    "enabled": true,
                    "registration": {
                      "clientId": "[parameters('entraClientId')]",
                      "openIdIssuer": "[format('https://sts.windows.net/{0}/v2.0', subscription().tenantId)]"
                    },
                    "validation": {
                      "allowedAudiences": [
                        "[format('api://{0}', parameters('entraClientId'))]"
                      ],
                      "jwtClaimChecks": {
                        "allowedClientApplications": "[parameters('allowedClientApplications')]"
                      }
                    }
                  }
                },
                "httpSettings": {
                  "requireHttps": true
                },
                "login": {
                  "tokenStore": {
                    "enabled": false
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "appServiceUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('name')), '2023-01-01').defaultHostName)]"
            },
            "appServicePrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('name')), '2023-01-01', 'full').identity.principalId]"
            },
            "appServiceName": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'monitoring')]",
        "[resourceId('Microsoft.Resources/deployments', 'networking')]",
        "[resourceId('Microsoft.Resources/deployments', 'search')]"
      ]
    },
    {
      "condition": "[not(equals(parameters('botEntraAppId'), ''))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "bot",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-bot-{1}', parameters('namePrefix'), parameters('environment'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "appServiceUrl": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app'), '2025-04-01').outputs.appServiceUrl.value]"
          },
          "entraAppId": {
            "value": "[parameters('botEntraAppId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "2572772044503056411"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "appServiceUrl": {
              "type": "string"
            },
            "entraAppId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.BotService/botServices",
              "apiVersion": "2022-09-15",
              "name": "[parameters('name')]",
              "location": "global",
              "kind": "azurebot",
              "sku": {
                "name": "S1"
              },
              "properties": {
                "displayName": "Legal AI Assistant",
                "description": "Secure AI assistant for law firm internal use",
                "endpoint": "[format('{0}/api/messages', parameters('appServiceUrl'))]",
                "msaAppId": "[parameters('entraAppId')]",
                "msaAppType": "SingleTenant",
                "msaAppTenantId": "[subscription().tenantId]",
                "schemaTransformationVersion": "1.3"
              }
            },
            {
              "type": "Microsoft.BotService/botServices/channels",
              "apiVersion": "2022-09-15",
              "name": "[format('{0}/{1}', parameters('name'), 'MsTeamsChannel')]",
              "location": "global",
              "properties": {
                "channelName": "MsTeamsChannel",
                "properties": {
                  "isEnabled": true
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.BotService/botServices', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.BotService/botServices/channels",
              "apiVersion": "2022-09-15",
              "name": "[format('{0}/{1}', parameters('name'), 'WebChatChannel')]",
              "location": "global",
              "properties": {
                "channelName": "WebChatChannel",
                "properties": {
                  "sites": [
                    {
                      "siteName": "Default",
                      "isEnabled": true
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.BotService/botServices', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "botName": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "botEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.BotService/botServices', parameters('name')), '2022-09-15').endpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'app')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "budget",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "amount": "[if(equals(parameters('environment'), 'prod'), createObject('value', 1000), createObject('value', 200))]",
          "contactEmails": {
            "value": "[parameters('budgetContactEmails')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "115248304463382959"
            }
          },
          "parameters": {
            "environment": {
              "type": "string"
            },
            "amount": {
              "type": "int"
            },
            "contactEmails": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Email addresses to receive budget alert notifications."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Consumption/budgets",
              "apiVersion": "2021-10-01",
              "name": "[format('budget-{0}', parameters('environment'))]",
              "properties": {
                "category": "Cost",
                "amount": "[parameters('amount')]",
                "timeGrain": "Monthly",
                "timePeriod": {
                  "startDate": "2025-01-01"
                },
                "notifications": {
                  "actualGreaterThan80Percent": {
                    "enabled": true,
                    "operator": "GreaterThan",
                    "threshold": 80,
                    "contactEmails": "[parameters('contactEmails')]",
                    "thresholdType": "Actual"
                  }
                }
              }
            }
          ]
        }
      }
    }
  ],
  "outputs": {
    "appUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'app'), '2025-04-01').outputs.appServiceUrl.value]"
    },
    "searchService": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'search'), '2025-04-01').outputs.searchName.value]"
    },
    "openaiEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'openai'), '2025-04-01').outputs.endpoint.value]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault'), '2025-04-01').outputs.keyVaultName.value]"
    }
  }
}